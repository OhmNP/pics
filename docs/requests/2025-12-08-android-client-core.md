# Android Client Core Features

**Status**: Draft
**Date**: 2025-12-08
**Author**: Antigravity

## 1. Summary
Implement the core user-facing functionality for the Android client application. This includes the ability to discover and pair with the PhotoSync Desktop Server, a **Dashboard** to view system status, a gallery view to browse local photos with synchronization status indicators, and controls to manage the synchronization process (start, pause, resume, stop).

## 2. Motivation
The Android client is the primary source of data for the PhotoSync system. Users need a seamless way to connect to their server and visualize which photos have been safely backed up. Explicit controls for synchronization determine when battery and network resources are used.

## 3. User Experience (UX)

### 3.1 First-Time Setup & Discovery
*   **Initial Launch**: Application opens to a "Connect to Server" screen.
*   **Auto-Discovery**: App listens for UDP broadcasts from the server to automatically find the server IP.
*   **Pairing**:
    *   User can tap "Scan QR Code" to scan the code generated by the Desktop Dashboard.
    *   Alternatively, if discovery fails, user can manually enter IP/Port.
*   **Success**: Upon successful pairing, the app navigates to the Dashboard view.

### 3.2 Dashboard (Home)
*   **Overview**: The landing screen after pairing.
*   **Server Info**: Displays connected server name/IP and connection status (Online/Offline).
*   **Sync Summary**: Large status card showing:
    *   "Synced: 1,250"
    *   "Pending: 45"
    *   "Space Used: 4.5 GB"
*   **Quick Actions**: Big "Sync Now" / "Pause" button.
*   **Recent Activity**: List of last 5 uploaded items (optional).

### 3.2 Main Gallery
*   **Layout**: A high-performance grid of photos from the device's local storage (Camera Roll).
*   **Interaction**:
    *   **Infinite Scrolling**: Users can scroll seamlessly through their entire library.
    *   **Pagination**: optimize memory usage by loading images in chunks.
*   **Status Indicators**: Each photo cell overlays a small icon:
    *   âœ… **Synced**: Photo is confirmed to be on the server.
    *   â³ **Pending**: Photo is queued for upload.
    *   ðŸ”„ **Syncing**: Photo is currently uploading.
    *   âŒ **Error**: Failed to sync (optional).

### 3.3 Sync Controls
*   **Status Bar/Float**: A persistent control panel or notification showing current state.
*   **States**:
    *   **Idle**: "All photos synced" or "Waiting to sync".
    *   **Syncing**: "Syncing 5 of 120...".
    *   **Paused**: "Sync Paused".
*   **Actions**:
    *   **Start**: Trigger a sync run immediately.
    *   **Pause**: Temporarily halt upload (e.g., to save bandwidth).
    *   **Resume**: Continue from where it left off.
    *   **Stop**: Cancel current session.

## 4. Technical Design

### Android Client

#### Architecture Components
*   **NetworkDiscoveryService**: A background component that listens on UDP port 50505 for server presence packets `{"service":"photosync","ip":"..."}`.
*   **SyncService**: The existing foreground service, enhanced to support state transitions (IDLE -> SYNCING -> PAUSED) and Binder interface for UI control.
*   **Repository Layer**:
    *   `MediaRepository`: Wraps `ContentResolver` to query `MediaStore.Images.Media`.
    *   `SyncStatusRepository`: A generic `Room` database table mapping `media_id` (MediaStore ID) or hash to `sync_status` (SYNCED, PENDING). Assumes server provided deduplication confirmation.
*   **UI Layer (Jetpack Compose)**:
    *   `GalleryScreen`: Uses `LazyVerticalGrid` with `paging-compose` for infinite scrolling.
    *   `DashboardScreen`: Displays connection status, stats summary, and main sync control button.
    *   Note: `MediaStore` paging requires using `ContentResolver` `query` with `LIMIT` and `OFFSET` or `Bundle` arguments on newer Android versions.

#### Data Flow
1.  **Discovery**: UDP Listener receives IP -> User confirms -> Handshake with Server.
2.  **Gallery Load**: `MediaRepository` queries `MediaStore`. `status` is joined from local `Room` DB.
3.  **Sync Start**: Service iterates unsynced items.
    *   Calculate Hash.
    *   Send Metadata to Server.
    *   Server replies "Skip" (Synced) or "Send" (Not Synced).
    *   If "Skip", update local DB to SYNCED.
    *   If "Send", upload binary -> Update local DB to SYNCED upon success.
4.  **Reconciliation (Fresh Install/Restore)**:
    *   Client calculates hashes for all local media.
    *   Sends a `BATCH_CHECK` (or similar) of hashes to server.
    *   Server returns list of *known* hashes.
    *   Client mass-updates local DB to SYNCED for matches.

### Desktop Server
*   **No major API changes anticipated** as the Sync Protocol (Discovery, Metadata, Data Transfer) is already defined in `ARCHITECTURE.md`.
*   Ensure `UdpBroadcaster` acts as expected for the Discovery feature.

## 5. Requirements / Acceptance Criteria
*   [ ] **Discovery**: Client detects server IP automatically on local network via UDP.
*   [ ] **Pairing**: Client can pair using QR code token validation flow.
*   [ ] **Dashboard**: Home screen displays real-time connection status and sync statistics (counts).
*   [ ] **Gallery Performance**: Gallery loads instantly and scrolls smoothly with >1000 items. 
*   [ ] **Pagination**: Memory usage remains stable during long scrolls.
*   [ ] **Visual Feedback**: Sync icons correctly reflect the state (pending vs synced).
*   [ ] **Control**: User can Pause and Resume the sync process; the service responds immediately.
*   [ ] **Reconciliation**: Efficiently update sync status of all local files against the server (e.g. on fresh install) without re-uploading.
*   [ ] **Persistence**: Sync status is remembered across app restarts (Local DB).

## 6. Questions / Open Issues
*   **Thumbnails**: Does the gallery use local thumbnails (MediaStore) or server thumbnails?
    *   *Assumption*: Local thumbnails for speed and offline availability.
*   **Deletions**: If a photo is deleted locally, does it delete from server?
    *   *Assumption*: No, it's a backup.
*   **Two-way Sync**: Is this required?
    *   *Decision*: No, strictly One-way (Android -> Desktop) for now as per Architecture ("Source of photo data").
